pipeline {
	agent any

	environment {
		CONNECT = 'http://sal-moonhyun-vm01.dc1.lan:8080'
		PROJECT = 'hello-java-coverity-demo'
	}
	
	stages {
		stage('Coverity Full Scan') {
			withCoverityEnvironment(coverityInstanceUrl: "$CONNECT", projectName: "$PROJECT", streamName: "$PROJECT-$BRANCH_NAME") {
				sh '''
					cov-build --dir idir --fs-capture-search $WORKSPACE mvn -B clean package -DskipTests
					cov-analyze --dir idir --ticker-mode none --strip-path $WORKSPACE --webapp-security
					cov-commit-defects --dir idir --ticker-mode none --url $COV_URL --stream $COV_STREAM \
						--description $BUILD_TAG --target Linux_x86_64 --version $GIT_COMMIT
				'''
				script { // Coverity Quality Gate
					count = coverityIssueCheck(viewName: 'OWASP Web Top 10', returnIssueCount: true)
					if (count != 0) { unstable 'issues detected' }
				}
			}
		}
	}
	post {
		always {
			cleanWs()
		}
	}
